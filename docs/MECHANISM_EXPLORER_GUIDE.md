# 游戏机制关联探索器 - 使用指南

## 概述

**游戏机制关联探索器** 是一个全新的三层级可视化工具，专为游戏策划设计，帮助你从业务层面理解游戏配置数据的关联关系和影响范围。

## 核心价值

### 为什么需要这个工具？

作为游戏策划，当你要删除一个物品、修改一个NPC、或者调整任务奖励时，你需要知道：
- ✅ **这个改动会影响哪些系统？** （机制层）
- ✅ **需要修改哪些配置表？** （表层）
- ✅ **具体哪些字段会受影响？** （字段层）
- ✅ **如何进行级联操作避免数据不一致？** （影响分析）

传统的关系分析只能看到表和字段的对应关系，**无法从业务视角理解系统间的依赖**。这个工具解决了这个痛点。

---

## 三层级架构

```
┌─────────────────────────────────────────────────────────────┐
│  第1层：机制层（业务系统）                                    │
│  物品系统 ↔ NPC系统 ↔ 商店系统 ↔ 任务系统 ↔ 掉落系统         │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  第2层：表层（每个机制下的表）                                │
│  ├─ 物品机制                                                 │
│  │  ├─ 服务端：items, item_weapon, item_armor              │
│  │  └─ 客户端：client_items, client_item_weapon            │
│  ├─ NPC机制                                                  │
│  │  ├─ 服务端：npcs_npc, npc_monster, npc_drop             │
│  │  └─ 客户端：client_npc_info, client_npc_appearance      │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  第3层：字段级联（字段间引用和影响）                          │
│  删除 items.id=1001 会影响：                                 │
│  ├─ npc_drop.item_id（3处）→ 需要删除掉落                   │
│  ├─ shop_items.item_id（2处）→ 需要下架商品                 │
│  ├─ quest_reward.item_id（1处）→ 需要修改任务奖励           │
│  └─ ... （级联操作建议）                                     │
└─────────────────────────────────────────────────────────────┘
```

---

## 启动方式

### 方法1：通过特性注册系统（推荐）

1. 启动主应用 `Dbxmltool`
2. 在工具栏或菜单中找到 **"机制关联探索器"**
3. 点击启动，工具会自动分析当前数据库的XML关系

### 方法2：直接创建实例

```java
GameMechanismExplorerStage explorer = new GameMechanismExplorerStage();
explorer.show();
```

---

## 使用流程

### 步骤1：等待自动分析（首次启动）

启动后，工具会自动执行以下分析：
1. 🔍 扫描所有XML文件，识别字段级关联
2. 🎯 识别游戏机制分类（14个内置系统）
3. 📊 构建机制→表→字段的三层模型
4. 🔗 构建影响分析索引

**预计耗时**：10秒 - 2分钟（取决于配置表数量）

### 步骤2：浏览机制层

顶部的**机制卡片区域**展示所有识别出的游戏系统：

| 系统名称 | 典型表名模式 | 说明 |
|---------|-------------|------|
| 物品系统 | item, equipment, weapon | 物品、道具、装备 |
| NPC系统 | npc, monster, mob, pet | 怪物、NPC、宠物 |
| 任务系统 | quest, mission, task | 任务、成就、剧情 |
| 商店系统 | shop, store, trade | 商店、交易、拍卖 |
| 技能系统 | skill, spell, ability | 技能、法术、天赋 |
| 掉落系统 | drop, loot, reward | 掉落、奖励、宝箱 |
| 强化系统 | enhance, upgrade, refine | 强化、升级、附魔 |
| 制作系统 | craft, combine, recipe | 制造、合成、配方 |
| 角色系统 | player, character, class | 玩家、角色、属性 |
| 地图系统 | map, zone, region, world | 地图、区域、场景 |
| 社交系统 | friend, guild, party | 好友、公会、组队 |
| PVP系统 | pvp, arena, battleground | 竞技场、战场、排行 |
| 邮件系统 | mail, message, notice | 邮件、消息、公告 |
| 配置数据 | config, setting, constant | 游戏配置、常量 |

**操作**：点击任意机制卡片，进入表层视图。

### 步骤3：查看表层结构

选择机制后，左侧显示该机制下的所有表，分为：
- 🖥️ **服务端表** - 数据库实际存储的表
- 💻 **客户端表** - 同步给客户端的表（带`client_`前缀）

**功能亮点**：
- 自动识别主表和子表（带`└─`标记的是子表）
- 显示每张表的字段数量
- 客户端/服务端表的对应关系（基于`tabMapping.json`）

**操作**：点击任意表，进入字段层分析。

### 步骤4：分析字段级关联

选择表后，右侧显示该表的所有字段及其关联信息：

| 列名 | 说明 |
|------|------|
| 字段名 | 字段的名称 |
| 类型 | 普通字段 / 外键（可能引用其他表） |
| 被引用次数 | 有多少个其他表的字段引用了这个字段 |
| 关联表 | 引用这个字段的表列表 |

**操作**：选择一个字段后，可以进行影响分析。

### 步骤5：执行影响分析

#### 5.1 删除影响分析

**使用场景**：要删除某个物品、NPC、任务等配置数据

**操作步骤**：
1. 选择包含该数据的表（如`items`）
2. 选择主键字段（如`id`）
3. 点击 **"分析删除影响"** 按钮
4. 输入要删除的值（如`1001`）
5. 查看影响报告

**报告内容**：
```
═══════════════════════════════════════════════════════════
删除影响分析报告
═══════════════════════════════════════════════════════════

表名：items
字段：id
值：1001
严重程度：警告

摘要：
警告：删除此数据会影响 3 张表，共 6 处引用

受影响的引用（按表分组）：
────────────────────────────────────────────────────────────

【npc_drop】3 处引用
  • 字段: item_id (置信度: 95.2%)
    → 需要删除或清空此字段的值
  • 字段: item_name (置信度: 87.3%)
    → 需要删除或清空此字段的值

【shop_items】2 处引用
  • 字段: item_id (置信度: 98.1%)
    → 需要删除或清空此字段的值

【quest_reward】1 处引用
  • 字段: reward_item (置信度: 76.5%)
    → 需要删除或清空此字段的值

级联操作建议：
────────────────────────────────────────────────────────────
1. 删除或清空 npc_drop 表中引用此数据的 3 条记录
2. 删除或清空 shop_items 表中引用此数据的 2 条记录
3. 删除或清空 quest_reward 表中引用此数据的 1 条记录

═══════════════════════════════════════════════════════════
```

#### 5.2 修改影响分析

**使用场景**：要修改某个主键值（如物品ID重命名）

**操作步骤**：
1. 选择表和字段
2. 点击 **"分析修改影响"** 按钮
3. 输入旧值和新值
4. 查看影响报告

**报告内容**：与删除类似，但建议是"更新"而非"删除"。

#### 5.3 严重程度说明

| 级别 | 颜色 | 说明 | 建议 |
|------|------|------|------|
| 安全 | 🟢 绿色 | 无其他表引用 | 可以直接删除/修改 |
| 警告 | 🟠 橙色 | 影响1-3张表 | 按建议执行级联操作 |
| 严重 | 🔴 红色 | 影响4张表以上 | 谨慎操作，建议备份 |

---

## 典型使用场景

### 场景1：删除废弃物品

**问题**：策划想删除物品ID=5001的装备，但不确定影响范围。

**解决方案**：
1. 打开机制探索器
2. 点击"物品系统"机制卡片
3. 选择`items`表
4. 选择`id`字段
5. 点击"分析删除影响"，输入`5001`
6. 查看报告，按建议依次清理`npc_drop`、`shop_items`、`quest_reward`等表的相关数据

### 场景2：理解系统间关联

**问题**：策划想了解NPC系统和物品系统是如何关联的。

**解决方案**：
1. 点击"NPC系统"机制卡片
2. 查看NPC系统下的所有表
3. 点击`npc_drop`表
4. 在字段列表中查看`item_id`字段的关联表
5. 发现它引用了`items`表，说明NPC掉落依赖物品系统

### 场景3：客户端/服务端表对照

**问题**：策划想知道服务端的`items`表对应客户端的哪张表。

**解决方案**：
1. 点击"物品系统"机制卡片
2. 对比左侧的"服务端表"和"客户端表"列表
3. 找到`items`（服务端）和`client_items`（客户端）的对应关系

### 场景4：批量数据迁移

**问题**：要将某个任务的奖励从物品A改为物品B。

**解决方案**：
1. 选择`quest_reward`表
2. 选择`reward_item`字段
3. 点击"分析修改影响"，输入旧值A和新值B
4. 查看影响范围，确认只影响任务系统
5. 按建议执行批量更新

---

## 核心功能详解

### 1. 自动机制识别

基于表名模式自动识别游戏系统，支持：
- ✅ 14种内置机制分类
- ✅ 自动处理`client_`前缀
- ✅ 识别主表和子表（带`__`的层级表）
- ✅ 统计每个机制下的表数量

**识别规则**：
```java
// 示例：表名包含"item"的归类为物品系统
"items" → 物品系统
"item_weapon" → 物品系统
"client_items" → 物品系统（客户端）

// 表名包含"npc"的归类为NPC系统
"npcs_npc" → NPC系统
"npc_monster" → NPC系统
"npc_drop" → NPC系统（虽然也与掉落相关）
```

### 2. 字段级关联分析

基于`XmlRelationshipAnalyzer`的强大关系分析能力：
- ✅ 自动发现Name字段关联（如`item_name`引用`items.name`）
- ✅ 计算置信度（基于覆盖率和语义相似度）
- ✅ 展示示例值
- ✅ 统计被引用次数

**算法特点**：
- 专注于Name字段（最可靠的关联）
- 自动过滤低置信度关系（< 60%）
- 支持跨文件关联分析

### 3. 影响分析引擎

**核心能力**：
- ✅ 反向索引：快速查找"谁引用了我"
- ✅ 正向索引：快速查找"我引用了谁"
- ✅ 依赖关系图：构建多层依赖树
- ✅ 级联操作建议：自动生成操作步骤

**技术实现**：
```java
// 构建索引
Map<String, Map<String, List<Relationship>>> reverseIndex;
Map<String, Map<String, List<Relationship>>> forwardIndex;

// 查询影响
ImpactReport report = impactAnalyzer.analyzeDeleteImpact(
    "items",  // 表名
    "id",     // 字段名
    "1001"    // 值
);
```

---

## 性能优化

### 首次启动优化

- **并发分析**：多线程扫描XML文件
- **增量更新**：后续启动复用缓存（计划中）
- **索引构建**：一次构建，多次查询

### 内存优化

- **懒加载**：只加载当前查看的机制数据
- **弱引用**：非活跃数据自动释放
- **分页展示**：大表分批加载

---

## 扩展性

### 自定义机制分类

你可以扩展`GameMechanismDetector.MechanismCategory`枚举来添加新的机制分类：

```java
// 添加新机制
MOUNT("坐骑系统", "坐骑、飞行器等",
    Pattern.compile("(?i).*(mount|vehicle|ride).*"))
```

### 自定义影响分析规则

你可以继承`ImpactAnalyzer`并覆盖分析逻辑：

```java
public class CustomImpactAnalyzer extends ImpactAnalyzer {
    @Override
    public ImpactReport analyzeDeleteImpact(...) {
        // 自定义分析逻辑
    }
}
```

---

## 常见问题 (FAQ)

### Q1: 为什么有些表没有分类到正确的机制？

**A**: 自动识别基于表名模式匹配。如果表名不符合常规命名，可能被归类为"其他"。你可以：
1. 修改表名以符合命名规范
2. 扩展`MechanismCategory`枚举添加新的匹配规则

### Q2: 影响分析的置信度如何计算？

**A**: 置信度基于多个因素：
- 源覆盖率（Source Coverage）× 70%
- 目标覆盖率（Target Coverage）× 30%
- 字段名相似度（Name Similarity）× 权重
- ID字段加成（+5%）

置信度 > 60% 的关系会被展示。

### Q3: 为什么有些关联没有显示？

**A**: 可能的原因：
1. 关系的置信度低于60%
2. 不是Name字段（当前只分析Name字段关联）
3. 数据量不足（< 5条记录）

### Q4: 可以导出分析报告吗？

**A**: 当前版本支持复制文本报告。导出功能（Excel/PDF）计划在下个版本实现。

### Q5: 分析很慢怎么办？

**A**: 优化建议：
1. 首次启动需要扫描所有XML，请耐心等待
2. 减少XML文件数量（移除无关文件）
3. 增加JVM内存：`-Xmx2G`

---

## 技术架构

### 核心类说明

| 类名 | 职责 | 文件路径 |
|------|------|---------|
| `GameMechanismDetector` | 游戏机制识别引擎 | `red.jiuzhou.analysis.GameMechanismDetector` |
| `ImpactAnalyzer` | 影响分析器 | `red.jiuzhou.analysis.ImpactAnalyzer` |
| `GameMechanismExplorerStage` | 三层可视化UI | `red.jiuzhou.ui.GameMechanismExplorerStage` |
| `XmlRelationshipAnalyzer` | XML关系分析（底层） | `red.jiuzhou.relationship.XmlRelationshipAnalyzer` |

### 数据流

```
XML文件
  ↓
XmlRelationshipAnalyzer（字段级关系）
  ↓
GameMechanismDetector（机制识别）
  ↓
ImpactAnalyzer（影响分析）
  ↓
GameMechanismExplorerStage（UI展示）
```

---

## 更新日志

### v1.0.0 (2025-12-02)

**新增功能**：
- ✅ 三层级可视化（机制→表→字段）
- ✅ 自动识别14种游戏机制
- ✅ 删除/修改影响分析
- ✅ 级联操作建议
- ✅ 客户端/服务端表对照

**技术亮点**：
- 基于`XmlRelationshipAnalyzer`的强大关系分析
- 反向索引 + 正向索引，快速查询
- JavaFX现代化UI设计
- 完全兼容Java 8

---

## 开发者指南

### 如何启动（开发模式）

```bash
# 编译项目
mvnd clean compile

# 运行主应用
mvnd javafx:run

# 或直接运行类
java -cp target/classes red.jiuzhou.ui.Dbxmltool
```

### 如何调试

1. 在IDE中设置断点
2. 运行`GameMechanismExplorerStage`的main方法（需要添加）
3. 或启动主应用后，从菜单打开"机制关联探索器"

### 如何贡献

1. Fork项目
2. 创建特性分支：`git checkout -b feature/new-mechanism`
3. 提交代码：`git commit -am 'Add new mechanism category'`
4. 推送分支：`git push origin feature/new-mechanism`
5. 创建Pull Request

---

## 未来规划

### 短期 (v1.1)
- [ ] 导出分析报告（Excel/PDF）
- [ ] 支持自定义机制分类
- [ ] 增加"依赖关系图"可视化
- [ ] 性能优化（缓存、增量更新）

### 中期 (v1.2)
- [ ] 支持更多字段类型关联（不只是Name）
- [ ] AI辅助影响分析（基于已有AI模型）
- [ ] 批量影响分析（同时分析多个值）
- [ ] 历史对比（查看两个版本的关联变化）

### 长期 (v2.0)
- [ ] 实时监控（数据变更时自动分析影响）
- [ ] 智能建议（AI推荐最佳级联操作）
- [ ] 图形化依赖编辑（拖拽式关系编辑）
- [ ] 多人协作（团队共享分析结果）

---

## 联系与反馈

- **项目地址**：https://github.com/xxx/dbxmlTool（待更新）
- **问题反馈**：请在GitHub Issues中提交
- **功能建议**：欢迎在Discussions中讨论

---

## 致谢

感谢以下技术和项目的支持：
- JavaFX - 强大的桌面UI框架
- Spring Boot - 企业级应用框架
- Hutool - 优秀的Java工具库
- Dom4j - XML解析引擎

---

**祝你使用愉快！如果这个工具帮助了你，请给我们一个Star ⭐️**
